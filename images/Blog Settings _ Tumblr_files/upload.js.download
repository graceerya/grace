/*! scripts/tumblr/upload.js */
!function(i,t){var e=window.__||function(i){return i},s=function(t,e){return this instanceof s?(e||(e={}),this.$el=i(t).first(),this.el=this.$el.get(0),this.logging=!1,e.id||(e.id=this.$el.attr("id")||this.$el.attr("name")||""),e.url||(e.url=""),e.default_url||(e.default_url=""),e.accept||(e.accept=!1),e.multiple||(e.multiple=!1),this.initialize(e),this):new s(t,e)};s.upload_icon=function(i,t){return t=_.extend({template:'<input type="hidden" name="<%- id %>" value="<%- url %>"/><div class="file_upload file_upload_icon"><div class="icon"></div><div class="not_progress"></div><div class="progress"></div></div>',initialize:function(i){this.$input=this.$el.find('input[type="hidden"]'),this.$fileinput_container=this.$el.find(".file_upload_icon"),this.$icon=this.$el.find(".icon"),this.$not_progress=this.$el.find(".not_progress"),this.$progress=this.$el.find(".progress")},reset:function(){this.$fileinput_container.removeClass("loading")},progress:function(i,t,e){var s=t?i/t:0;s=Math.max(0,Math.min(s,1));var n=Math.round(100*s),o=100-n;this.$not_progress.width(o+"%"),this.$progress.width(n+"%"),s&&this.$fileinput_container.addClass("loading")},success:function(i,t,e){this.reset(),this.$input.val(i).trigger("change")},error:function(i,t,s){i.length&&i[0]||(i=[e("Something strange happened while saving that. Please try again in a bit?")]),1===i.length?Tumblr.Dialog.alert(i[0]):Tumblr.Dialog.alert("<ul><li>"+i.join("</li><li>")+"</li></ul>"),this.reset()},fail:function(i){Tumblr.Dialog.alert(e("We encountered an unexpected error. Please try again.")),this.reset()}},t),new s(i,t)},s.upload_button=function(i,t){return t=_.extend({button_class:"gray light",button_label:e("Upload"),template:'<input type="hidden" name="<%- id %>" value="<%- url %>"/><div class="file_upload file_upload_button button <%- button_class %>"><span class="button_label"><%- button_label %></span><span class="button_loader"></span></div>',initialize:function(i){this.$button=this.$el.find(".button"),this.$label=this.$button.children(".button_label"),this.$loader=this.$button.children(".button_loader"),this.$input=this.$el.find('input[type="hidden"]'),this.$fileinput_container=this.$button},reset:function(){this.$fileinput_container.removeClass("loading"),this.loader&&this.loader.stop()},send:function(i,t){this.loader||(this.loader=Tumblr.Loader({color:"#ffffff",top:"0",left:"0",position:"absolute",className:""})),this.$fileinput_container.addClass("loading"),this.loader.start(this.$loader)},success:function(i,t,e){this.$input.val(i).trigger("change"),_.delay(_.bind(function(){this.reset()},this),500)},error:function(i,t,s){i.length&&i[0]||(i=[e("Something strange happened while saving that. Please try again in a bit?")]),1===i.length?Tumblr.Dialog.alert(i[0]):Tumblr.Dialog.alert("<ul><li>"+i.join("</li><li>")+"</li></ul>"),this.reset()},fail:function(i){Tumblr.Dialog.alert(e("We encountered an unexpected error. Please try again.")),this.reset()}},t),new s(i,t)},s.upload_dropzone=function(i,t){return t=_.extend({multiple:!0,button_class:"",dropzone_label:e("Add files"),dropzone_info:"",template:'<div class="file_upload file_upload_dropzone dropzone <%- button_class %>"><div class="dropzone_box"><div class="dropzone_label"><div><%= dropzone_label %></div><% if (dropzone_info) { %><div class="small"><%= dropzone_info %></div><% } %></div></div><div class="Knight-Rider-loader centered"><div class="Knight-Rider-bar"></div><div class="Knight-Rider-bar"></div><div class="Knight-Rider-bar"></div></div></div>',initialize:function(i){this.$input=this.$el.find('input[type="hidden"]'),this.$fileinput_container=this.$el.find(".file_upload"),this.$loader=this.$el.find(".Knight-Rider-loader")},reset:function(){this.$fileinput_container.removeClass("loading"),this.$loader.removeClass("animate")},send:function(i,t){this.$fileinput_container.addClass("loading"),this.$loader.addClass("animate")},success:function(i,t,e){this.$input.val(i).trigger("change"),_.delay(_.bind(function(){this.reset()},this),500)},error:function(i,t,s){i.length&&i[0]||(i=[e("Something strange happened while saving that. Please try again in a bit?")]),1===i.length?Tumblr.Dialog.alert(i[0]):Tumblr.Dialog.alert("<ul><li>"+i.join("</li><li>")+"</li></ul>"),this.reset()},fail:function(i){Tumblr.Dialog.alert(e("We encountered an unexpected error. Please try again.")),this.reset()}},t),new s(i,t)},s.prototype={log:function(){return window.console?"function"==typeof window.console.debug?window.console.debug.apply(window.console,arguments):"function"==typeof window.console.log?window.console.log.apply(window.console,arguments):!1:!1},initialize:function(i){return this.options=i,this.id=i.id,this.url=i.url,this.default_url=i.default_url,"string"==typeof i.template&&(i.template=_.template(i.template)),"function"==typeof i.template&&(this.options.prepend?this.$el.prepend(i.template(_.omit(i,"template"))):this.$el.append(i.template(_.omit(i,"template")))),this.logging&&this.log(this.id,"initialize()"),"function"==typeof this.options.initialize&&this.options.initialize.call(this,i),this.fileupload_init(),this},progress:function(i,t,e){return this.logging&&this.log(this.id,"progress()",i,t,_.pluck(e,"name").join(",")),"function"==typeof this.options.progress&&this.options.progress.call(this,i,t,e),this},reset:function(){return this.logging&&this.log(this.id,"reset()"),"function"==typeof this.options.reset&&this.options.reset.call(this),this},validate:function(i){return this.errors=[],i.length<1?this.errors.push("Please select a file to upload."):i.length>1&&this.errors.push("Please select only one file to upload."),_.isFunction(this.options.validate)&&this.options.validate.call(this,i,this.errors),this.logging&&this.log(this.id,"validate()",this.errors),!this.errors.length},fileupload_data:function(){return this.$el.data("blueimpFileupload")},fileupload_destroy:function(){return this.fileupload_data()&&(this.logging&&this.log(this.id,"fileupload_destroy()"),this.$el.fileupload("destroy")),this},fileupload_init:function(){return this.fileupload_destroy(),this.$fileinput_container&&this.$fileinput_container.length||(this.$fileinput_container=this.$el),this.$fileinput&&this.$fileinput.remove(),this.$fileinput=i('<input type="file" name="file"/>'),this.options.accept&&this.$fileinput.prop("accept",this.options.accept),this.options.multiple&&this.$fileinput.prop("multiple",!0),this.$fileinput_container.append(this.$fileinput),this.fileupload_options=_.extend({singleFileUploads:!0,limitConcurrentUploads:this.options.multiple?void 0:1,sequentialUploads:!!this.options.multiple,autoUpload:!0,fileInput:this.$fileinput,formData:[],dataType:"json",url:"/svc/upload/static_file",dropZone:null,pasteZone:null,withFormKey:!0},this.options.fileupload_options),this.fileupload_options.change=_.bind(function(i,t){this.logging&&this.log(this.id,"fileupload.change()"),this.$fileinput=this.$el.find('input[type="file"]')},this),this.fileupload_options.add=_.bind(function(i,t){return"function"==typeof this.options.add?this.options.add(t):(this.logging&&this.log(this.id,"fileupload.add()"),void t.submit())},this),this.fileupload_options.submit=_.bind(function(i,t){return this.validate(t.files)?void(this.logging&&this.log(this.id,"fileupload.submit()","ok")):(this.logging&&this.log(this.id,"fileupload.submit()","error"),"function"==typeof this.options.error&&this.options.error.call(this,this.errors),this.errors=!1,!1)},this),this.fileupload_options.send=_.bind(function(i,t){this.logging&&this.log(this.id,"fileupload.send()",_.pluck(t.files,"name").join(","),_.pluck(t.originalFiles,"name").join(",")),t.withFormKey=!0,"function"==typeof this.options.send&&this.options.send.call(this,t.files,t.originalFiles),this.progress(0)},this),this.fileupload_options.progress=_.bind(function(i,t){this.logging&&this.log(this.id,"fileupload.progress()",_.pluck(t.files,"name").join(",")),this.progress(t.loaded,t.total,t.files)},this),this.fileupload_options.done=_.bind(function(i,t){this.logging&&this.log(this.id,"fileupload.done()",_.pluck(t.files,"name").join(",")),this.progress(t.loaded,t.total,t.files);var e=t.result.response;e.success?"function"==typeof this.options.success&&this.options.success.call(this,e.url,e,t.files):"function"==typeof this.options.error&&this.options.error.call(this,[e.message],e,t.files)},this),this.fileupload_options.fail=_.bind(function(i,t){this.logging&&this.log(this.id,"fileupload.fail()"),this.reset(),"abort"!==t.textStatus&&"function"==typeof this.options.fail&&this.options.fail.call(this,t)},this),this.fileupload_options.always=_.bind(function(i,t){this.logging&&this.log(this.id,"fileupload.always()"),"function"==typeof this.options.always&&this.options.always.call(this,t)},this),this.$el.fileupload(this.fileupload_options),this.reset(),this}},t.Upload=s}(jQuery,Tumblr||{});